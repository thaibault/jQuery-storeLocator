#!/usr/bin/env node

// -*- coding: utf-8 -*-
'use strict';
/* !
    region header
    Copyright Torben Sickert (info["~at~"]torben.website) 16.12.2012

    License
    -------

    This library written by Torben Sickert stand under a creative commons naming
    3.0 unported license. see http://creativecommons.org/licenses/by/3.0/deed.de
    endregion
*/
// region imports

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _fs = require('fs');

var fileSystem = _interopRequireWildcard(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _helper = require('./helper.compiled');

var _helper2 = _interopRequireDefault(_helper);

var _package = require('./package');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

// NOTE: Only needed for debugging this file.
try {
    require('source-map-support/register');
} catch (error) {}
// NOTE: "{configuration as metaConfiguration}" would result in a read only
// variable named "metaConfiguration".


/* eslint-enable no-unused-vars */

/* eslint-disable no-unused-vars */
let metaConfiguration = _package.configuration;
metaConfiguration.default.path.context = _path2.default.resolve(__dirname, '../../');
metaConfiguration.default.contextType = 'main';
if (_path2.default.basename(_path2.default.dirname(process.cwd())) === 'node_modules' || _path2.default.basename(_path2.default.dirname(process.cwd())) === '.staging' && _path2.default.basename(_path2.default.dirname(_path2.default.dirname(process.cwd()))) === 'node_modules') {
    metaConfiguration.default.path.context = process.cwd();
    metaConfiguration.default.contextType = 'dependency';
}
let specificConfiguration;
try {
    // IgnoreTypeCheck
    specificConfiguration = require(_path2.default.join(metaConfiguration.default.path.context, 'package'));
} catch (error) {
    specificConfiguration = { name: 'mockup' };
    metaConfiguration.default.path.context = process.cwd();
}
const name = specificConfiguration.name;
specificConfiguration = specificConfiguration.webOptimizer || {};
specificConfiguration.name = name;
// endregion
// region loading default configuration
// NOTE: Given node command line arguments results in "npm_config_*"
// environment variables.
let debug = metaConfiguration.default.debug;
if (specificConfiguration.debug !== undefined) debug = specificConfiguration.debug;
if (process.env.npm_config_production) debug = false;else if (process.env.npm_config_debug) debug = true;
metaConfiguration.default.path.context += '/';
// Merges final default configuration object depending on given target
// environment.
const libraryConfiguration = metaConfiguration.library;
let configuration;
if (debug) configuration = _helper2.default.extendObject(true, metaConfiguration.default, metaConfiguration.debug);else configuration = metaConfiguration.default;
if (typeof configuration.library === 'object') _helper2.default.extendObject(true, libraryConfiguration, configuration.library);
if (specificConfiguration.library === true || specificConfiguration.library === undefined && configuration.library) configuration = _helper2.default.extendObject(true, configuration, libraryConfiguration);
// endregion
// region merging and evaluating default, test, dynamic and specific settings
// Merges project specific configurations with default ones.
configuration = _helper2.default.extendObject(true, configuration, specificConfiguration);
configuration.debug = debug;
// / region load additional dynamically given configuration
let count = 0;
let filePath = null;
while (true) {
    const newFilePath = configuration.path.context + `.dynamicConfiguration-${ count }.json`;
    try {
        fileSystem.accessSync(newFilePath, fileSystem.F_OK);
    } catch (error) {
        break;
    }
    filePath = newFilePath;
    count += 1;
}
let runtimeInformation = {
    givenCommandLineArguments: process.argv
};
if (filePath) {
    runtimeInformation = JSON.parse(fileSystem.readFileSync(filePath, {
        encoding: 'utf-8' }));
    fileSystem.unlink(filePath, error => {
        if (error) throw error;
    });
}
if (runtimeInformation.givenCommandLineArguments.length > 2)
    // region apply documentation configuration
    if (runtimeInformation.givenCommandLineArguments[2] === 'document') _helper2.default.extendObject(true, configuration, configuration.document);
    // endregion
    // region apply test configuration
    else if (runtimeInformation.givenCommandLineArguments[2] === 'testInBrowser') _helper2.default.extendObject(true, configuration, configuration.testInBrowser);else if (runtimeInformation.givenCommandLineArguments[2] === 'test') _helper2.default.extendObject(true, configuration, configuration.test);
// endregion
// / endregion
_helper2.default.extendObject(true, configuration, runtimeInformation);
let result = null;
const evaluationFunction = configuration =>
// IgnoreTypeCheck
new Function('configuration', 'return ' + runtimeInformation.givenCommandLineArguments[runtimeInformation.givenCommandLineArguments.length - 1])(configuration);
try {
    result = evaluationFunction(configuration);
} catch (error) {}
if (_helper2.default.isPlainObject(result)) _helper2.default.extendObject(true, configuration, result);
// / region determine existing pre compiled dll manifests file paths
configuration.dllManifestFilePaths = [];
let targetDirectory = null;
try {
    targetDirectory = fileSystem.statSync(configuration.path.target);
} catch (error) {}
if (targetDirectory && targetDirectory.isDirectory()) fileSystem.readdirSync(configuration.path.target).forEach(fileName => {
    if (fileName.match(/^.*\.dll-manifest\.json$/)) configuration.dllManifestFilePaths.push(_path2.default.resolve(configuration.path.target, fileName));
});
// / endregion
// / region build absolute paths
for (const pathConfiguration of [configuration.path, configuration.path.asset]) for (const key of ['source', 'target']) if (pathConfiguration[key]) pathConfiguration[key] = _path2.default.resolve(configuration.path.context, _helper2.default.resolveDynamicDataStructure(pathConfiguration[key], configuration)) + '/';
// / endregion
const resolvedConfiguration = _helper2.default.resolveDynamicDataStructure(configuration);
// endregion
// region consolidate file specific build configuration
// Apply default file level build configurations to all file type specific
// ones.
const defaultConfiguration = resolvedConfiguration.build.default;
delete resolvedConfiguration.build.default;
for (const type in resolvedConfiguration.build) if (resolvedConfiguration.build.hasOwnProperty(type)) resolvedConfiguration.build[type] = _helper2.default.extendObject(true, {}, defaultConfiguration, _helper2.default.extendObject(true, { extension: type }, resolvedConfiguration.build[type], { type }));
// endregion
// region apply webpack html plugin workaround
/*
    NOTE: Provides a workaround to handle a bug with changed loader
    configurations.
*/
for (const htmlConguration of resolvedConfiguration.files.html) if (typeof htmlConguration.template === 'string' && htmlConguration.template.includes('!')) {
    const newTemplateString = new String(htmlConguration.template);
    newTemplateString.replace = (string => (_search, _replacement) => string)(htmlConguration.template);
    htmlConguration.template = newTemplateString;
}
// endregion
exports.default = resolvedConfiguration;
// region vim modline
// vim: set tabstop=4 shiftwidth=4 expandtab:
// vim: foldmethod=marker foldmarker=region,endregion:
// endregion

//# sourceMappingURL=data:application/json;base64,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QkFBa0IsT0FBbEIsR0FBNEIsQ0FBRSxNQUFELElBQTRCLENBQ3JELE9BRHFELEVBQzlCLFlBRDhCLEtBSTdDLE1BSmdCLEVBSVIsZ0JBQWdCLFFBSlIsQ0FBNUI7QUFLQSxvQkFBZ0IsUUFBaEIsR0FBMkIsaUJBQTNCO0FBQ0g7QUFDTDtrQkFDZSxxQjtBQUNmO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImNvbmZpZ3VyYXRvci5jb21waWxlZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcbi8vIEBmbG93XG4vLyAtKi0gY29kaW5nOiB1dGYtOCAtKi1cbid1c2Ugc3RyaWN0J1xuLyogIVxuICAgIHJlZ2lvbiBoZWFkZXJcbiAgICBDb3B5cmlnaHQgVG9yYmVuIFNpY2tlcnQgKGluZm9bXCJ+YXR+XCJddG9yYmVuLndlYnNpdGUpIDE2LjEyLjIwMTJcblxuICAgIExpY2Vuc2VcbiAgICAtLS0tLS0tXG5cbiAgICBUaGlzIGxpYnJhcnkgd3JpdHRlbiBieSBUb3JiZW4gU2lja2VydCBzdGFuZCB1bmRlciBhIGNyZWF0aXZlIGNvbW1vbnMgbmFtaW5nXG4gICAgMy4wIHVucG9ydGVkIGxpY2Vuc2UuIHNlZSBodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9saWNlbnNlcy9ieS8zLjAvZGVlZC5kZVxuICAgIGVuZHJlZ2lvblxuKi9cbi8vIHJlZ2lvbiBpbXBvcnRzXG5pbXBvcnQgKiBhcyBmaWxlU3lzdGVtIGZyb20gJ2ZzJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbi8vIE5PVEU6IE9ubHkgbmVlZGVkIGZvciBkZWJ1Z2dpbmcgdGhpcyBmaWxlLlxudHJ5IHtcbiAgICByZXF1aXJlKCdzb3VyY2UtbWFwLXN1cHBvcnQvcmVnaXN0ZXInKVxufSBjYXRjaCAoZXJyb3IpIHt9XG5cbmltcG9ydCBIZWxwZXIgZnJvbSAnLi9oZWxwZXIuY29tcGlsZWQnXG4vLyBOT1RFOiBcIntjb25maWd1cmF0aW9uIGFzIG1ldGFDb25maWd1cmF0aW9ufVwiIHdvdWxkIHJlc3VsdCBpbiBhIHJlYWQgb25seVxuLy8gdmFyaWFibGUgbmFtZWQgXCJtZXRhQ29uZmlndXJhdGlvblwiLlxuaW1wb3J0IHtjb25maWd1cmF0aW9uIGFzIGdpdmVuTWV0YUNvbmZpZ3VyYXRpb259IGZyb20gJy4vcGFja2FnZSdcbi8qIGVzbGludC1kaXNhYmxlIG5vLXVudXNlZC12YXJzICovXG5pbXBvcnQgdHlwZSB7XG4gICAgRGVmYXVsdENvbmZpZ3VyYXRpb24sIEhUTUxDb25maWd1cmF0aW9uLCBNZXRhQ29uZmlndXJhdGlvbiwgUGxhaW5PYmplY3QsXG4gICAgUmVzb2x2ZWRDb25maWd1cmF0aW9uXG59IGZyb20gJy4vdHlwZSdcbi8qIGVzbGludC1lbmFibGUgbm8tdW51c2VkLXZhcnMgKi9cbmxldCBtZXRhQ29uZmlndXJhdGlvbjpNZXRhQ29uZmlndXJhdGlvbiA9IGdpdmVuTWV0YUNvbmZpZ3VyYXRpb25cbm1ldGFDb25maWd1cmF0aW9uLmRlZmF1bHQucGF0aC5jb250ZXh0ID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uLy4uLycpXG5tZXRhQ29uZmlndXJhdGlvbi5kZWZhdWx0LmNvbnRleHRUeXBlID0gJ21haW4nXG5pZiAoXG4gICAgcGF0aC5iYXNlbmFtZShwYXRoLmRpcm5hbWUocHJvY2Vzcy5jd2QoKSkpID09PSAnbm9kZV9tb2R1bGVzJyB8fFxuICAgIHBhdGguYmFzZW5hbWUocGF0aC5kaXJuYW1lKHByb2Nlc3MuY3dkKCkpKSA9PT0gJy5zdGFnaW5nJyAmJlxuICAgIHBhdGguYmFzZW5hbWUocGF0aC5kaXJuYW1lKHBhdGguZGlybmFtZShwcm9jZXNzLmN3ZCgpKSkpID09PSAnbm9kZV9tb2R1bGVzJ1xuKSB7XG4gICAgbWV0YUNvbmZpZ3VyYXRpb24uZGVmYXVsdC5wYXRoLmNvbnRleHQgPSBwcm9jZXNzLmN3ZCgpXG4gICAgbWV0YUNvbmZpZ3VyYXRpb24uZGVmYXVsdC5jb250ZXh0VHlwZSA9ICdkZXBlbmRlbmN5J1xufVxubGV0IHNwZWNpZmljQ29uZmlndXJhdGlvbjpQbGFpbk9iamVjdFxudHJ5IHtcbiAgICAvLyBJZ25vcmVUeXBlQ2hlY2tcbiAgICBzcGVjaWZpY0NvbmZpZ3VyYXRpb24gPSByZXF1aXJlKHBhdGguam9pbihcbiAgICAgICAgbWV0YUNvbmZpZ3VyYXRpb24uZGVmYXVsdC5wYXRoLmNvbnRleHQsICdwYWNrYWdlJykpXG59IGNhdGNoIChlcnJvcikge1xuICAgIHNwZWNpZmljQ29uZmlndXJhdGlvbiA9IHtuYW1lOiAnbW9ja3VwJ31cbiAgICBtZXRhQ29uZmlndXJhdGlvbi5kZWZhdWx0LnBhdGguY29udGV4dCA9IHByb2Nlc3MuY3dkKClcbn1cbmNvbnN0IG5hbWU6c3RyaW5nID0gc3BlY2lmaWNDb25maWd1cmF0aW9uLm5hbWVcbnNwZWNpZmljQ29uZmlndXJhdGlvbiA9IHNwZWNpZmljQ29uZmlndXJhdGlvbi53ZWJPcHRpbWl6ZXIgfHwge31cbnNwZWNpZmljQ29uZmlndXJhdGlvbi5uYW1lID0gbmFtZVxuLy8gZW5kcmVnaW9uXG4vLyByZWdpb24gbG9hZGluZyBkZWZhdWx0IGNvbmZpZ3VyYXRpb25cbi8vIE5PVEU6IEdpdmVuIG5vZGUgY29tbWFuZCBsaW5lIGFyZ3VtZW50cyByZXN1bHRzIGluIFwibnBtX2NvbmZpZ18qXCJcbi8vIGVudmlyb25tZW50IHZhcmlhYmxlcy5cbmxldCBkZWJ1Zzpib29sZWFuID0gbWV0YUNvbmZpZ3VyYXRpb24uZGVmYXVsdC5kZWJ1Z1xuaWYgKHNwZWNpZmljQ29uZmlndXJhdGlvbi5kZWJ1ZyAhPT0gdW5kZWZpbmVkKVxuICAgIGRlYnVnID0gc3BlY2lmaWNDb25maWd1cmF0aW9uLmRlYnVnXG5pZiAocHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19wcm9kdWN0aW9uKVxuICAgIGRlYnVnID0gZmFsc2VcbmVsc2UgaWYgKHByb2Nlc3MuZW52Lm5wbV9jb25maWdfZGVidWcpXG4gICAgZGVidWcgPSB0cnVlXG5tZXRhQ29uZmlndXJhdGlvbi5kZWZhdWx0LnBhdGguY29udGV4dCArPSAnLydcbi8vIE1lcmdlcyBmaW5hbCBkZWZhdWx0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IGRlcGVuZGluZyBvbiBnaXZlbiB0YXJnZXRcbi8vIGVudmlyb25tZW50LlxuY29uc3QgbGlicmFyeUNvbmZpZ3VyYXRpb246UGxhaW5PYmplY3QgPSBtZXRhQ29uZmlndXJhdGlvbi5saWJyYXJ5XG5sZXQgY29uZmlndXJhdGlvbjpEZWZhdWx0Q29uZmlndXJhdGlvblxuaWYgKGRlYnVnKVxuICAgIGNvbmZpZ3VyYXRpb24gPSBIZWxwZXIuZXh0ZW5kT2JqZWN0KFxuICAgICAgICB0cnVlLCBtZXRhQ29uZmlndXJhdGlvbi5kZWZhdWx0LCBtZXRhQ29uZmlndXJhdGlvbi5kZWJ1ZylcbmVsc2VcbiAgICBjb25maWd1cmF0aW9uID0gbWV0YUNvbmZpZ3VyYXRpb24uZGVmYXVsdFxuaWYgKHR5cGVvZiBjb25maWd1cmF0aW9uLmxpYnJhcnkgPT09ICdvYmplY3QnKVxuICAgIEhlbHBlci5leHRlbmRPYmplY3QodHJ1ZSwgbGlicmFyeUNvbmZpZ3VyYXRpb24sIGNvbmZpZ3VyYXRpb24ubGlicmFyeSlcbmlmIChcbiAgICBzcGVjaWZpY0NvbmZpZ3VyYXRpb24ubGlicmFyeSA9PT0gdHJ1ZSB8fFxuICAgIHNwZWNpZmljQ29uZmlndXJhdGlvbi5saWJyYXJ5ID09PSB1bmRlZmluZWQgJiYgY29uZmlndXJhdGlvbi5saWJyYXJ5XG4pXG4gICAgY29uZmlndXJhdGlvbiA9IEhlbHBlci5leHRlbmRPYmplY3QoXG4gICAgICAgIHRydWUsIGNvbmZpZ3VyYXRpb24sIGxpYnJhcnlDb25maWd1cmF0aW9uKVxuLy8gZW5kcmVnaW9uXG4vLyByZWdpb24gbWVyZ2luZyBhbmQgZXZhbHVhdGluZyBkZWZhdWx0LCB0ZXN0LCBkeW5hbWljIGFuZCBzcGVjaWZpYyBzZXR0aW5nc1xuLy8gTWVyZ2VzIHByb2plY3Qgc3BlY2lmaWMgY29uZmlndXJhdGlvbnMgd2l0aCBkZWZhdWx0IG9uZXMuXG5jb25maWd1cmF0aW9uID0gSGVscGVyLmV4dGVuZE9iamVjdCh0cnVlLCBjb25maWd1cmF0aW9uLCBzcGVjaWZpY0NvbmZpZ3VyYXRpb24pXG5jb25maWd1cmF0aW9uLmRlYnVnID0gZGVidWdcbi8vIC8gcmVnaW9uIGxvYWQgYWRkaXRpb25hbCBkeW5hbWljYWxseSBnaXZlbiBjb25maWd1cmF0aW9uXG5sZXQgY291bnQ6bnVtYmVyID0gMFxubGV0IGZpbGVQYXRoOj9zdHJpbmcgPSBudWxsXG53aGlsZSAodHJ1ZSkge1xuICAgIGNvbnN0IG5ld0ZpbGVQYXRoOnN0cmluZyA9IGNvbmZpZ3VyYXRpb24ucGF0aC5jb250ZXh0ICtcbiAgICAgICAgYC5keW5hbWljQ29uZmlndXJhdGlvbi0ke2NvdW50fS5qc29uYFxuICAgIHRyeSB7XG4gICAgICAgIGZpbGVTeXN0ZW0uYWNjZXNzU3luYyhuZXdGaWxlUGF0aCwgZmlsZVN5c3RlbS5GX09LKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGJyZWFrXG4gICAgfVxuICAgIGZpbGVQYXRoID0gbmV3RmlsZVBhdGhcbiAgICBjb3VudCArPSAxXG59XG5sZXQgcnVudGltZUluZm9ybWF0aW9uOlBsYWluT2JqZWN0ID0ge1xuICAgIGdpdmVuQ29tbWFuZExpbmVBcmd1bWVudHM6IHByb2Nlc3MuYXJndlxufVxuaWYgKGZpbGVQYXRoKSB7XG4gICAgcnVudGltZUluZm9ybWF0aW9uID0gSlNPTi5wYXJzZShmaWxlU3lzdGVtLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwge1xuICAgICAgICBlbmNvZGluZzogJ3V0Zi04J30pKVxuICAgIGZpbGVTeXN0ZW0udW5saW5rKGZpbGVQYXRoLCAoZXJyb3I6P0Vycm9yKTp2b2lkID0+IHtcbiAgICAgICAgaWYgKGVycm9yKVxuICAgICAgICAgICAgdGhyb3cgZXJyb3JcbiAgICB9KVxufVxuaWYgKHJ1bnRpbWVJbmZvcm1hdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzLmxlbmd0aCA+IDIpXG4gICAgLy8gcmVnaW9uIGFwcGx5IGRvY3VtZW50YXRpb24gY29uZmlndXJhdGlvblxuICAgIGlmIChydW50aW1lSW5mb3JtYXRpb24uZ2l2ZW5Db21tYW5kTGluZUFyZ3VtZW50c1syXSA9PT0gJ2RvY3VtZW50JylcbiAgICAgICAgSGVscGVyLmV4dGVuZE9iamVjdCh0cnVlLCBjb25maWd1cmF0aW9uLCBjb25maWd1cmF0aW9uLmRvY3VtZW50KVxuICAgIC8vIGVuZHJlZ2lvblxuICAgIC8vIHJlZ2lvbiBhcHBseSB0ZXN0IGNvbmZpZ3VyYXRpb25cbiAgICBlbHNlIGlmIChcbiAgICAgICAgcnVudGltZUluZm9ybWF0aW9uLmdpdmVuQ29tbWFuZExpbmVBcmd1bWVudHNbMl0gPT09ICd0ZXN0SW5Ccm93c2VyJ1xuICAgIClcbiAgICAgICAgSGVscGVyLmV4dGVuZE9iamVjdCh0cnVlLCBjb25maWd1cmF0aW9uLCBjb25maWd1cmF0aW9uLnRlc3RJbkJyb3dzZXIpXG4gICAgZWxzZSBpZiAocnVudGltZUluZm9ybWF0aW9uLmdpdmVuQ29tbWFuZExpbmVBcmd1bWVudHNbMl0gPT09ICd0ZXN0JylcbiAgICAgICAgSGVscGVyLmV4dGVuZE9iamVjdCh0cnVlLCBjb25maWd1cmF0aW9uLCBjb25maWd1cmF0aW9uLnRlc3QpXG4gICAgLy8gZW5kcmVnaW9uXG4vLyAvIGVuZHJlZ2lvblxuSGVscGVyLmV4dGVuZE9iamVjdCh0cnVlLCBjb25maWd1cmF0aW9uLCBydW50aW1lSW5mb3JtYXRpb24pXG5sZXQgcmVzdWx0Oj9QbGFpbk9iamVjdCA9IG51bGxcbmNvbnN0IGV2YWx1YXRpb25GdW5jdGlvbiA9IChjb25maWd1cmF0aW9uOlBsYWluT2JqZWN0KTo/UGxhaW5PYmplY3QgPT5cbiAgICAvLyBJZ25vcmVUeXBlQ2hlY2tcbiAgICBuZXcgRnVuY3Rpb24oJ2NvbmZpZ3VyYXRpb24nLCAncmV0dXJuICcgK1xuICAgICAgICBydW50aW1lSW5mb3JtYXRpb24uZ2l2ZW5Db21tYW5kTGluZUFyZ3VtZW50c1tydW50aW1lSW5mb3JtYXRpb25cbiAgICAgICAgICAgIC5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzLmxlbmd0aCAtIDFdXG4gICAgKShjb25maWd1cmF0aW9uKVxudHJ5IHtcbiAgICByZXN1bHQgPSBldmFsdWF0aW9uRnVuY3Rpb24oY29uZmlndXJhdGlvbilcbn0gY2F0Y2ggKGVycm9yKSB7fVxuaWYgKEhlbHBlci5pc1BsYWluT2JqZWN0KHJlc3VsdCkpXG4gICAgSGVscGVyLmV4dGVuZE9iamVjdCh0cnVlLCBjb25maWd1cmF0aW9uLCByZXN1bHQpXG4vLyAvIHJlZ2lvbiBkZXRlcm1pbmUgZXhpc3RpbmcgcHJlIGNvbXBpbGVkIGRsbCBtYW5pZmVzdHMgZmlsZSBwYXRoc1xuY29uZmlndXJhdGlvbi5kbGxNYW5pZmVzdEZpbGVQYXRocyA9IFtdXG5sZXQgdGFyZ2V0RGlyZWN0b3J5Oj9PYmplY3QgPSBudWxsXG50cnkge1xuICAgIHRhcmdldERpcmVjdG9yeSA9IGZpbGVTeXN0ZW0uc3RhdFN5bmMoY29uZmlndXJhdGlvbi5wYXRoLnRhcmdldClcbn0gY2F0Y2ggKGVycm9yKSB7fVxuaWYgKHRhcmdldERpcmVjdG9yeSAmJiB0YXJnZXREaXJlY3RvcnkuaXNEaXJlY3RvcnkoKSlcbiAgICBmaWxlU3lzdGVtLnJlYWRkaXJTeW5jKGNvbmZpZ3VyYXRpb24ucGF0aC50YXJnZXQpLmZvckVhY2goKFxuICAgICAgICBmaWxlTmFtZTpzdHJpbmdcbiAgICApOnZvaWQgPT4ge1xuICAgICAgICBpZiAoZmlsZU5hbWUubWF0Y2goL14uKlxcLmRsbC1tYW5pZmVzdFxcLmpzb24kLykpXG4gICAgICAgICAgICBjb25maWd1cmF0aW9uLmRsbE1hbmlmZXN0RmlsZVBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGF0aC50YXJnZXQsIGZpbGVOYW1lKSlcbiAgICB9KVxuLy8gLyBlbmRyZWdpb25cbi8vIC8gcmVnaW9uIGJ1aWxkIGFic29sdXRlIHBhdGhzXG5mb3IgKGNvbnN0IHBhdGhDb25maWd1cmF0aW9uOntba2V5OnN0cmluZ106e1trZXk6c3RyaW5nXTpzdHJpbmd9fHN0cmluZ30gb2YgW1xuICAgIGNvbmZpZ3VyYXRpb24ucGF0aCwgY29uZmlndXJhdGlvbi5wYXRoLmFzc2V0XG5dKVxuICAgIGZvciAoY29uc3Qga2V5OnN0cmluZyBvZiBbJ3NvdXJjZScsICd0YXJnZXQnXSlcbiAgICAgICAgaWYgKHBhdGhDb25maWd1cmF0aW9uW2tleV0pXG4gICAgICAgICAgICBwYXRoQ29uZmlndXJhdGlvbltrZXldID0gcGF0aC5yZXNvbHZlKFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGF0aC5jb250ZXh0LCBIZWxwZXIucmVzb2x2ZUR5bmFtaWNEYXRhU3RydWN0dXJlKFxuICAgICAgICAgICAgICAgICAgICBwYXRoQ29uZmlndXJhdGlvbltrZXldLCBjb25maWd1cmF0aW9uKVxuICAgICAgICAgICAgKSArICcvJ1xuLy8gLyBlbmRyZWdpb25cbmNvbnN0IHJlc29sdmVkQ29uZmlndXJhdGlvbjpSZXNvbHZlZENvbmZpZ3VyYXRpb24gPVxuICAgIEhlbHBlci5yZXNvbHZlRHluYW1pY0RhdGFTdHJ1Y3R1cmUoY29uZmlndXJhdGlvbilcbi8vIGVuZHJlZ2lvblxuLy8gcmVnaW9uIGNvbnNvbGlkYXRlIGZpbGUgc3BlY2lmaWMgYnVpbGQgY29uZmlndXJhdGlvblxuLy8gQXBwbHkgZGVmYXVsdCBmaWxlIGxldmVsIGJ1aWxkIGNvbmZpZ3VyYXRpb25zIHRvIGFsbCBmaWxlIHR5cGUgc3BlY2lmaWNcbi8vIG9uZXMuXG5jb25zdCBkZWZhdWx0Q29uZmlndXJhdGlvbjpQbGFpbk9iamVjdCA9IHJlc29sdmVkQ29uZmlndXJhdGlvbi5idWlsZC5kZWZhdWx0XG5kZWxldGUgcmVzb2x2ZWRDb25maWd1cmF0aW9uLmJ1aWxkLmRlZmF1bHRcbmZvciAoY29uc3QgdHlwZTpzdHJpbmcgaW4gcmVzb2x2ZWRDb25maWd1cmF0aW9uLmJ1aWxkKVxuICAgIGlmIChyZXNvbHZlZENvbmZpZ3VyYXRpb24uYnVpbGQuaGFzT3duUHJvcGVydHkodHlwZSkpXG4gICAgICAgIHJlc29sdmVkQ29uZmlndXJhdGlvbi5idWlsZFt0eXBlXSA9IEhlbHBlci5leHRlbmRPYmplY3QodHJ1ZSwge1xuICAgICAgICB9LCBkZWZhdWx0Q29uZmlndXJhdGlvbiwgSGVscGVyLmV4dGVuZE9iamVjdChcbiAgICAgICAgICAgIHRydWUsIHtleHRlbnNpb246IHR5cGV9LCByZXNvbHZlZENvbmZpZ3VyYXRpb24uYnVpbGRbdHlwZV0sIHt0eXBlfSlcbiAgICAgICAgKVxuLy8gZW5kcmVnaW9uXG4vLyByZWdpb24gYXBwbHkgd2VicGFjayBodG1sIHBsdWdpbiB3b3JrYXJvdW5kXG4vKlxuICAgIE5PVEU6IFByb3ZpZGVzIGEgd29ya2Fyb3VuZCB0byBoYW5kbGUgYSBidWcgd2l0aCBjaGFuZ2VkIGxvYWRlclxuICAgIGNvbmZpZ3VyYXRpb25zLlxuKi9cbmZvciAoXG4gICAgY29uc3QgaHRtbENvbmd1cmF0aW9uOkhUTUxDb25maWd1cmF0aW9uIG9mIHJlc29sdmVkQ29uZmlndXJhdGlvbi5maWxlcy5odG1sXG4pXG4gICAgaWYgKFxuICAgICAgICB0eXBlb2YgaHRtbENvbmd1cmF0aW9uLnRlbXBsYXRlID09PSAnc3RyaW5nJyAmJlxuICAgICAgICBodG1sQ29uZ3VyYXRpb24udGVtcGxhdGUuaW5jbHVkZXMoJyEnKVxuICAgICkge1xuICAgICAgICBjb25zdCBuZXdUZW1wbGF0ZVN0cmluZzpPYmplY3QgPSBuZXcgU3RyaW5nKGh0bWxDb25ndXJhdGlvbi50ZW1wbGF0ZSlcbiAgICAgICAgbmV3VGVtcGxhdGVTdHJpbmcucmVwbGFjZSA9ICgoc3RyaW5nOnN0cmluZyk6RnVuY3Rpb24gPT4gKFxuICAgICAgICAgICAgX3NlYXJjaDpSZWdFeHB8c3RyaW5nLCBfcmVwbGFjZW1lbnQ6c3RyaW5nfChcbiAgICAgICAgICAgICAgICAuLi5tYXRjaGVzOkFycmF5PHN0cmluZz5cbiAgICAgICAgICAgICkgPT4gc3RyaW5nXG4gICAgICAgICk6c3RyaW5nID0+IHN0cmluZykoaHRtbENvbmd1cmF0aW9uLnRlbXBsYXRlKVxuICAgICAgICBodG1sQ29uZ3VyYXRpb24udGVtcGxhdGUgPSBuZXdUZW1wbGF0ZVN0cmluZ1xuICAgIH1cbi8vIGVuZHJlZ2lvblxuZXhwb3J0IGRlZmF1bHQgcmVzb2x2ZWRDb25maWd1cmF0aW9uXG4vLyByZWdpb24gdmltIG1vZGxpbmVcbi8vIHZpbTogc2V0IHRhYnN0b3A9NCBzaGlmdHdpZHRoPTQgZXhwYW5kdGFiOlxuLy8gdmltOiBmb2xkbWV0aG9kPW1hcmtlciBmb2xkbWFya2VyPXJlZ2lvbixlbmRyZWdpb246XG4vLyBlbmRyZWdpb25cbiJdfQ==